<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial; padding: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 20px; padding: 10px; font-size: 16px; background-color: #2196F3; color: white; border: none; cursor: pointer; }
    #total { font-weight: bold; color: green; margin-top: 10px; }
    #sugerencias {
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      position: absolute;
      background: white;
      z-index: 1000;
      width: 100%;
    }
    .sugerencia {
      padding: 6px;
      cursor: pointer;
    }
    .sugerencia:hover {
      background-color: #f0f0f0;
    }
  </style>
  <script>
    let productos = [];
    let productoSeleccionado = null;

    function cargarProductos() {
      google.script.run.withSuccessHandler(function(lista) {
        productos = lista;
      }).obtenerListaProductos();
    }

    function filtrarProductos() {
      const input = document.getElementById("buscadorProducto").value.toLowerCase();
      const contenedor = document.getElementById("sugerencias");
      contenedor.innerHTML = "";

      if (!input) return;

      const resultados = productos.filter(p =>
        p.nombre.toLowerCase().includes(input)
      );

      resultados.forEach(p => {
        const div = document.createElement("div");
        div.className = "sugerencia";
        div.textContent = `${p.nombre}`;
        div.onclick = function() {
          document.getElementById("buscadorProducto").value = p.nombre;
          productoSeleccionado = p;
          contenedor.innerHTML = "";
          calcularTotal();
        };
        contenedor.appendChild(div);
      });
    }

    function calcularTotal() {
      const cantidad = parseFloat(document.getElementById("cantidad").value) || 0;
      const descuento = parseFloat(document.getElementById("descuento").value) || 0;
      const esMerma = document.getElementById("esMerma").checked;

      if (productoSeleccionado && !esMerma) {
        const total = cantidad * productoSeleccionado.precio * (1 - descuento);
        document.getElementById("total").innerText = "Total estimado: $" + total.toFixed(0);
      } else {
        document.getElementById("total").innerText = "";
      }
    }

    function enviarFormulario() {
      if (!productoSeleccionado) {
        alert("Debes seleccionar un producto desde el buscador.");
        return;
      }

      const cantidad = parseFloat(document.getElementById("cantidad").value);
      if (!cantidad || cantidad <= 0) {
        alert("La cantidad debe ser mayor a 0.");
        return;
      }

      const data = {
        idProducto: productoSeleccionado.id,
        nombreProducto: productoSeleccionado.nombre,
        cantidad: cantidad,
        descuento: parseFloat(document.getElementById("descuento").value) || 0,
        esMerma: document.getElementById("esMerma").checked,
        costoUnitario: productoSeleccionado.costo,
        precioUnitario: productoSeleccionado.precio,
        cliente: document.getElementById("cliente").value || "",
        mailCliente: document.getElementById("mailCliente").value || ""
      };

      google.script.run.withSuccessHandler(() => {
        alert("Registro exitoso");
        google.script.host.close();
      }).registrarIngreso(data);
    }

    window.onload = cargarProductos;
  </script>
</head>
  <body>
  <h2>Ingreso Rápido</h2>

  <label for="buscadorProducto">Buscar producto</label>
  <input type="text" id="buscadorProducto" oninput="filtrarProductos()" placeholder="Ej: barra, isotónica...">
  <div id="sugerencias"></div>

  <label for="cantidad">Cantidad</label>
  <input type="number" id="cantidad" onchange="calcularTotal()">

  <label for="descuento">% Descuento (ej: 0.10 para 10%)</label>
  <input type="number" id="descuento" step="0.01" onchange="calcularTotal()">

  <label><input type="checkbox" id="esMerma" onchange="calcularTotal()"> ¿Es Merma?</label>

  <div id="total"></div>

  <label for="cliente">Cliente</label>
  <input type="text" id="cliente" placeholder="Nombre del cliente">

  <label for="mailCliente">Mail Cliente</label>
  <input type="email" id="mailCliente" placeholder="cliente@email.com">

  <button onclick="enviarFormulario()">Registrar</button>
  </body>
</html>

